//SPDX-License-Identifier: MIT
pragma solidity >=0.8.0 <0.9.0;

// ===============================================
// Transaction Property 2 - íŠ¸ëœì­ì…˜ ì†ì„± ê³ ê¸‰ ì˜ˆì œ
// ===============================================
// 
// ğŸ“Œ íŠ¸ëœì­ì…˜ ì†ì„± ì‹¬í™” ê°œë…:
//   - msg.sender: í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì£¼ì²´ì˜ ì£¼ì†Œ
//   - msg.value: íŠ¸ëœì­ì…˜ê³¼ í•¨ê»˜ ì „ì†¡ëœ ì´ë”ì˜ ì–‘ (wei ë‹¨ìœ„)
//   - í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜(selector): í•¨ìˆ˜ì˜ ê³ ìœ  ì‹ë³„ì (keccak256 í•´ì‹œì˜ ì²« 4ë°”ì´íŠ¸)
//   - mapping: í‚¤-ê°’ ìŒì„ ì €ì¥í•˜ëŠ” í•´ì‹œí…Œì´ë¸” í˜•íƒœì˜ ë°ì´í„° êµ¬ì¡°
//   - bytes4: 4ë°”ì´íŠ¸ ê³ ì • ê¸¸ì´ ë°”ì´íŠ¸ ë°°ì—´ (í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ì— ì‚¬ìš©)
//
// ğŸ’¡ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê°œë…:
//   - í•¨ìˆ˜ëª…ê³¼ ë§¤ê°œë³€ìˆ˜ íƒ€ì…ì„ ì¡°í•©í•œ ë¬¸ìì—´ì˜ keccak256 í•´ì‹œê°’
//   - ì˜ˆ: "transfer(address,uint256)" â†’ keccak256 â†’ ì²« 4ë°”ì´íŠ¸ ì¶”ì¶œ
//   - ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜ë¥¼ ì‹ë³„í•˜ëŠ” ë° ì‚¬ìš©
//   - EVMì—ì„œ í•¨ìˆ˜ í˜¸ì¶œ ì‹œ calldataì˜ ì²« 4ë°”ì´íŠ¸ë¡œ ì „ì†¡ë¨
//
// ğŸ”— ì‹¤ìš©ì  í™œìš© ì‚¬ë¡€:
//   - ì£¼ë¬¸ ì‹œìŠ¤í…œ: ì‚¬ìš©ìë³„ ì£¼ë¬¸ ê¸ˆì•¡ ì¶”ì 
//   - ê¶Œí•œ ê²€ì¦: íŠ¹ì • í•¨ìˆ˜ í˜¸ì¶œ ê¶Œí•œ í™•ì¸
//   - ê²°ì œ ì‹œìŠ¤í…œ: ìµœì†Œ ê¸ˆì•¡ ìš”êµ¬ì‚¬í•­ ê²€ì¦
//   - ë©”íƒ€íŠ¸ëœì­ì…˜: í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê¸°ë°˜ ê²€ì¦
// ===============================================

/**
 * @title TransactionProperty2
 * @dev íŠ¸ëœì­ì…˜ ì†ì„±ê³¼ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ í™œìš©í•œ ê³ ê¸‰ ì˜ˆì œ ì»¨íŠ¸ë™íŠ¸
 * @notice ì£¼ë¬¸ ê´€ë¦¬, í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê²€ì¦, ê¸ˆì•¡ í™•ì¸ ê¸°ëŠ¥ ì œê³µ
 */
contract TransactionProperty2 {
    // ========== ìƒíƒœ ë³€ìˆ˜ ==========
    
    /**
     * @dev ì‚¬ìš©ìë³„ ì£¼ë¬¸ ê¸ˆì•¡ì„ ì €ì¥í•˜ëŠ” ë§¤í•‘
     * @notice key: ì‚¬ìš©ì ì£¼ì†Œ, value: ì£¼ë¬¸ ê¸ˆì•¡ (wei ë‹¨ìœ„)
     * 
     * ë§¤í•‘(Mapping) íŠ¹ì§•:
     * - í‚¤-ê°’ ìŒì„ ì €ì¥í•˜ëŠ” í•´ì‹œí…Œì´ë¸”
     * - ê°€ìŠ¤ íš¨ìœ¨ì ì¸ ë°ì´í„° ì €ì¥/ì¡°íšŒ (O(1) ì‹œê°„ë³µì¡ë„)
     * - ê¸°ë³¸ê°’ì€ í•´ë‹¹ íƒ€ì…ì˜ ì´ˆê¸°ê°’ (uintì˜ ê²½ìš° 0)
     * - í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ë„ ì—ëŸ¬ ì—†ì´ ê¸°ë³¸ê°’ ë°˜í™˜
     * - ì´í„°ë ˆì´ì…˜(ìˆœíšŒ) ë¶ˆê°€ëŠ¥ (í‚¤ ëª©ë¡ì„ ë³„ë„ ê´€ë¦¬í•´ì•¼ í•¨)
     */
    mapping(address => uint) private orderList;
    
    /**
     * @dev í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ìš© ë³€ìˆ˜
     * @notice íŠ¹ì • í•¨ìˆ˜ì˜ selectorë¥¼ ì €ì¥í•˜ì—¬ ë¹„êµ ê²€ì¦ì— ì‚¬ìš©
     * 
     * bytes4 íƒ€ì…:
     * - 4ë°”ì´íŠ¸(32ë¹„íŠ¸) ê³ ì • ê¸¸ì´ ë°”ì´íŠ¸ ë°°ì—´
     * - í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ì €ì¥ì— ìµœì í™”ë¨
     * - keccak256 í•´ì‹œì˜ ì²« 4ë°”ì´íŠ¸ë¥¼ ì €ì¥
     * - ë©”ëª¨ë¦¬ íš¨ìœ¨ì  (uint32ì™€ ë™ì¼í•œ í¬ê¸°)
     */
    bytes4 private checkFunction;
    
    // ========== ì´ë²¤íŠ¸ ì •ì˜ ==========
    
    /**
     * @dev ìƒˆë¡œìš´ ì£¼ë¬¸ì´ ìƒì„±ë  ë•Œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸
     * @param sender ì£¼ë¬¸ì ì£¼ì†Œ
     * @param amount ì£¼ë¬¸ ê¸ˆì•¡ (wei ë‹¨ìœ„)
     * @param timestamp ì£¼ë¬¸ ìƒì„± ì‹œê°„
     */
    event OrderCreated(address indexed sender, uint amount, uint timestamp);
    
    /**
     * @dev í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ ê²°ê³¼ ì´ë²¤íŠ¸
     * @param caller í˜¸ì¶œì ì£¼ì†Œ
     * @param expectedSelector ì˜ˆìƒ ì‹œê·¸ë‹ˆì²˜
     * @param actualSelector ì‹¤ì œ ì‹œê·¸ë‹ˆì²˜
     * @param isMatch ì¼ì¹˜ ì—¬ë¶€
     */
    event SignatureVerified(
        address indexed caller, 
        bytes4 expectedSelector, 
        bytes4 actualSelector, 
        bool isMatch
    );
    
    // ========== ìƒì„±ì ==========
    
    /**
     * @dev ì»¨íŠ¸ë™íŠ¸ ìƒì„±ì
     * @notice ê²€ì¦í•  í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ ë¯¸ë¦¬ ì„¤ì •
     */
    constructor() {
        // "newOrderList()" í•¨ìˆ˜ì˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ ë¯¸ë¦¬ ê³„ì‚°í•˜ì—¬ ì €ì¥
        // keccak256("newOrderList()") â†’ ì²« 4ë°”ì´íŠ¸ ì¶”ì¶œ
        checkFunction = bytes4(keccak256("newOrderList()"));
    }
    
    // ========== ì£¼ìš” í•¨ìˆ˜ë“¤ ==========
    
    /**
     * @dev ìƒˆë¡œìš´ ì£¼ë¬¸ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
     * @notice í˜¸ì¶œìì˜ ì£¼ì†Œì™€ ì „ì†¡ëœ ì´ë”ëŸ‰ì„ ê¸°ë¡
     * 
     * payable í•œì •ì:
     * - í•¨ìˆ˜ê°€ ì´ë”ë¥¼ ë°›ì„ ìˆ˜ ìˆìŒì„ ì˜ë¯¸
     * - payable ì—†ì´ëŠ” msg.valueê°€ 0ì´ì–´ì•¼ í•¨
     * - ì´ë”ë¥¼ ë°›ëŠ” ëª¨ë“  í•¨ìˆ˜ëŠ” payableë¡œ ì„ ì–¸ í•„ìˆ˜
     * 
     * external ê°€ì‹œì„±:
     * - ì™¸ë¶€ì—ì„œë§Œ í˜¸ì¶œ ê°€ëŠ¥ (ë‹¤ë¥¸ ì»¨íŠ¸ë™íŠ¸ë‚˜ EOAì—ì„œ)
     * - ë‚´ë¶€ì—ì„œëŠ” this.functionName() í˜•íƒœë¡œë§Œ í˜¸ì¶œ ê°€ëŠ¥
     * - publicë³´ë‹¤ ê°€ìŠ¤ íš¨ìœ¨ì  (calldata ì§ì ‘ ì‚¬ìš©)
     */
    function newOrderList() external payable {
        // msg.sender: í˜„ì¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì£¼ì²´ì˜ ì£¼ì†Œ
        // - EOA(ê°œì¸ ì§€ê°‘)ì´ë©´ ì§€ê°‘ ì£¼ì†Œ
        // - ë‹¤ë¥¸ ì»¨íŠ¸ë™íŠ¸ë©´ ê·¸ ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ
        // - íŠ¸ëœì­ì…˜ ì›ë³¸ ë°œì‹ ìëŠ” tx.originìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥
        
        // msg.value: ì´ íŠ¸ëœì­ì…˜ê³¼ í•¨ê»˜ ì „ì†¡ëœ ì´ë”ëŸ‰ (wei ë‹¨ìœ„)
        // - 1 ETH = 10^18 wei
        // - payable í•¨ìˆ˜ì—ì„œë§Œ 0ì´ ì•„ë‹Œ ê°’ ê°€ëŠ¥
        // - í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ì—ëŠ” ë³€ê²½ë˜ì§€ ì•ŠëŠ” ìƒìˆ˜ê°’
        
        orderList[msg.sender] = msg.value;
        
        // ì´ë²¤íŠ¸ ë°œìƒìœ¼ë¡œ ì£¼ë¬¸ ìƒì„± ë¡œê¹…
        emit OrderCreated(msg.sender, msg.value, block.timestamp);
    }
    
    /**
     * @dev í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ í•¨ìˆ˜
     * @return bool ì €ì¥ëœ ì‹œê·¸ë‹ˆì²˜ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ì—¬ë¶€
     * @notice í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ ë¡œì§ ë°ëª¨
     * 
     * view í•œì •ì:
     * - ìƒíƒœë¥¼ ì½ê¸°ë§Œ í•˜ê³  ë³€ê²½í•˜ì§€ ì•ŠìŒ
     * - ê°€ìŠ¤ ì†Œëª¨ ì—†ìŒ (ë¡œì»¬ì—ì„œ ì‹¤í–‰)
     * - storage ë³€ìˆ˜ ì½ê¸°ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ ì“°ê¸° ë¶ˆê°€
     * - pureì™€ ë‹¬ë¦¬ ìƒíƒœ ë³€ìˆ˜ ì ‘ê·¼ ê°€ëŠ¥
     */
    function newCheckFunction() external view returns (bool) {
        // í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê³„ì‚° ê³¼ì •:
        // 1. í•¨ìˆ˜ëª…ê³¼ ë§¤ê°œë³€ìˆ˜ íƒ€ì…ì„ ë¬¸ìì—´ë¡œ ì¡°í•©
        // 2. keccak256 í•´ì‹œ í•¨ìˆ˜ ì ìš©
        // 3. ê²°ê³¼ì˜ ì²« 4ë°”ì´íŠ¸ ì¶”ì¶œ
        bytes4 selector = bytes4(keccak256("newOrderList()"));
        
        // ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìš©ë„ë¡œ í™œìš©:
        // - ë©”íƒ€íŠ¸ëœì­ì…˜ì—ì„œ í˜¸ì¶œ í•¨ìˆ˜ ê²€ì¦
        // - í”„ë¡ì‹œ íŒ¨í„´ì—ì„œ í•¨ìˆ˜ ë¼ìš°íŒ…
        // - ê¶Œí•œ ê´€ë¦¬ ì‹œìŠ¤í…œì—ì„œ í•¨ìˆ˜ë³„ ì ‘ê·¼ ì œì–´
        // - ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•œ ì»¨íŠ¸ë™íŠ¸ì—ì„œ í•¨ìˆ˜ í˜¸í™˜ì„± ê²€ì‚¬
        
        bool isMatch = (selector == checkFunction);
        
        // ì£¼ì˜: view í•¨ìˆ˜ì—ì„œëŠ” ì´ë²¤íŠ¸ ë°œìƒ ë¶ˆê°€ (ìƒíƒœ ë³€ê²½ìœ¼ë¡œ ê°„ì£¼)
        // ê²€ì¦ ê²°ê³¼ë¥¼ í™•ì¸í•˜ë ¤ë©´ ë³„ë„ì˜ non-view í•¨ìˆ˜ ì‚¬ìš© í•„ìš”
        
        return isMatch;
    }
    
    /**
     * @dev í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ ë° ì´ë²¤íŠ¸ ë¡œê¹… (ìƒíƒœ ë³€ê²½ í•¨ìˆ˜)
     * @return bool ì €ì¥ëœ ì‹œê·¸ë‹ˆì²˜ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ì—¬ë¶€
     * @notice ê²€ì¦ ê²°ê³¼ë¥¼ ì´ë²¤íŠ¸ë¡œ ê¸°ë¡í•˜ëŠ” ë²„ì „
     */
    function verifyAndLogSignature() external returns (bool) {
        bytes4 selector = bytes4(keccak256("newOrderList()"));
        bool isMatch = (selector == checkFunction);
        
        // ê²€ì¦ ê²°ê³¼ ë¡œê¹… (ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ì—ì„œë§Œ ê°€ëŠ¥)
        emit SignatureVerified(msg.sender, checkFunction, selector, isMatch);
        
        return isMatch;
    }
    
    /**
     * @dev íŠ¹ì • ì‚¬ìš©ìì˜ ì£¼ë¬¸ ê¸ˆì•¡ì´ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ëŠ”ì§€ í™•ì¸
     * @param sender í™•ì¸í•  ì‚¬ìš©ì ì£¼ì†Œ
     * @param price ìš”êµ¬ë˜ëŠ” ìµœì†Œ ê¸ˆì•¡ (wei ë‹¨ìœ„)
     * @return bool ì‚¬ìš©ìì˜ ì£¼ë¬¸ ê¸ˆì•¡ì´ ìš”êµ¬ ê¸ˆì•¡ ì´ìƒì¸ì§€ ì—¬ë¶€
     * @notice ê²°ì œ ê²€ì¦, ê¶Œí•œ í™•ì¸ ë“±ì— í™œìš© ê°€ëŠ¥
     * 
     * ë§¤ê°œë³€ìˆ˜ ì„¤ê³„ ì›ì¹™:
     * - sender: ê²€ì¦ ëŒ€ìƒ ì£¼ì†Œ (msg.senderì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
     * - price: ë¹„êµ ê¸°ì¤€ê°’ (wei ë‹¨ìœ„ë¡œ ì •ë°€í•œ ê³„ì‚°)
     * 
     * í™œìš© ì‚¬ë¡€:
     * - VIP íšŒì› ìê²© í™•ì¸ (ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡)
     * - í• ì¸ í˜œíƒ ì ìš© ê¸°ì¤€
     * - ì°¸ì—¬ ê¶Œí•œ ê²€ì¦ (ìµœì†Œ ìŠ¤í…Œì´í‚¹ ê¸ˆì•¡)
     * - ë³´ìƒ ì§€ê¸‰ ì¡°ê±´ í™•ì¸
     */
    function checkOrderFunction(address sender, uint price) external view returns (bool) {
        // ë§¤í•‘ì—ì„œ ê°’ ì¡°íšŒ:
        // - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‚¤ì˜ ê²½ìš° ê¸°ë³¸ê°’(0) ë°˜í™˜
        // - ë³„ë„ì˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ì´ í•„ìš”í•œ ê²½ìš° ì¶”ê°€ ë¡œì§ êµ¬í˜„
        uint userOrderAmount = orderList[sender];
        
        // ë…¼ë¦¬ ì—°ì‚°ì í™œìš©:
        // >= : í¬ê±°ë‚˜ ê°™ìŒ (ìµœì†Œ ì¡°ê±´ ë§Œì¡± í™•ì¸)
        // > : ì´ˆê³¼ (ì—„ê²©í•œ ì¡°ê±´)
        // == : ì •í™•íˆ ì¼ì¹˜ (íŠ¹ì • ê¸ˆì•¡)
        return userOrderAmount >= price;
    }
    
    // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==========
    
    /**
     * @dev íŠ¹ì • ì‚¬ìš©ìì˜ ì£¼ë¬¸ ê¸ˆì•¡ ì¡°íšŒ
     * @param sender ì¡°íšŒí•  ì‚¬ìš©ì ì£¼ì†Œ
     * @return uint í•´ë‹¹ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ê¸ˆì•¡ (wei ë‹¨ìœ„)
     * @notice íˆ¬ëª…ì„±ì„ ìœ„í•œ ë°ì´í„° ì ‘ê·¼ í•¨ìˆ˜
     */
    function getOrderAmount(address sender) external view returns (uint) {
        return orderList[sender];
    }
    
    /**
     * @dev í˜„ì¬ ì„¤ì •ëœ ì²´í¬ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ì¡°íšŒ
     * @return bytes4 ì €ì¥ëœ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜
     * @notice ë””ë²„ê¹… ë° ê²€ì¦ìš© í•¨ìˆ˜
     */
    function getCheckFunctionSelector() external view returns (bytes4) {
        return checkFunction;
    }
    
    /**
     * @dev í˜¸ì¶œìì˜ ì£¼ë¬¸ ê¸ˆì•¡ ì¡°íšŒ (í¸ì˜ í•¨ìˆ˜)
     * @return uint í˜¸ì¶œìì˜ ì£¼ë¬¸ ê¸ˆì•¡ (wei ë‹¨ìœ„)
     * @notice msg.senderë¥¼ ìë™ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” í¸ì˜ í•¨ìˆ˜
     */
    function getMyOrderAmount() external view returns (uint) {
        return orderList[msg.sender];
    }
    
    /**
     * @dev ì»¨íŠ¸ë™íŠ¸ê°€ ë³´ìœ í•œ ì´ ì´ë”ëŸ‰ ì¡°íšŒ
     * @return uint ì»¨íŠ¸ë™íŠ¸ ì”ì•¡ (wei ë‹¨ìœ„)
     * @notice ì»¨íŠ¸ë™íŠ¸ ì¬ì • ìƒíƒœ í™•ì¸ìš©
     */
    function getContractBalance() external view returns (uint) {
        return address(this).balance;
    }
    
    /**
     * @dev ì„ì˜ì˜ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ê³„ì‚° ìœ í‹¸ë¦¬í‹°
     * @param functionSignature í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ë¬¸ìì—´ (ì˜ˆ: "transfer(address,uint256)")
     * @return bytes4 ê³„ì‚°ëœ í•¨ìˆ˜ ì„ íƒì
     * @notice ê°œë°œ ë° í…ŒìŠ¤íŠ¸ìš© ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
     */
    function calculateSelector(string memory functionSignature) external pure returns (bytes4) {
        return bytes4(keccak256(bytes(functionSignature)));
    }
    
    // ========== ê´€ë¦¬ì í•¨ìˆ˜ë“¤ ==========
    
    /**
     * @dev ì»¨íŠ¸ë™íŠ¸ ì†Œìœ ìê°€ ì´ë”ë¥¼ ì¸ì¶œí•˜ëŠ” í•¨ìˆ˜ (ê¸°ë³¸ êµ¬í˜„)
     * @notice ì‹¤ì œ í”„ë¡œë•ì…˜ì—ì„œëŠ” ì ‘ê·¼ ì œì–´ ì¶”ê°€ í•„ìš”
     */
    function withdraw() external {
        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” onlyOwner ë“±ì˜ ì ‘ê·¼ ì œì–´ ì¶”ê°€
        require(msg.sender != address(0), "Invalid caller");
        
        uint balance = address(this).balance;
        require(balance > 0, "No funds to withdraw");
        
        // callì„ ì‚¬ìš©í•œ ì•ˆì „í•œ ì´ë” ì „ì†¡
        (bool success, ) = payable(msg.sender).call{value: balance}("");
        require(success, "Withdraw failed");
    }
}
    
